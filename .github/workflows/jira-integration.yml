name: Jira Integration

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  sync-with-jira:
    name: Sync PR with Jira using Claude
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD)
          # Truncate if too large (max 50KB for Claude)
          if [ ${#DIFF} -gt 50000 ]; then
            DIFF="${DIFF:0:50000}... (truncated)"
          fi
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update PR with Claude
        uses: actions/github-script@v7
        env:
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_KEY }}
          JIRA_BASE_URL: 'https://medease-uok.atlassian.net'
          JIRA_EMAIL: 'dhanikaanupama2000@gmail.com'
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PR_DIFF: ${{ steps.diff.outputs.diff }}
        with:
          script: |
            const title = context.payload.pull_request.title;
            const body = context.payload.pull_request.body || '';
            const prNumber = context.issue.number;
            const prDiff = process.env.PR_DIFF || '';

            console.log('=== Starting Jira-GitHub Integration ===');

            // Extract issue references (Fixes #123, Closes #456, etc.)
            const issueKeywords = ['fixes', 'closes', 'resolves', 'fix', 'close', 'resolve'];
            const issuePattern = new RegExp(`(${issueKeywords.join('|')})\\s+#(\\d+)`, 'gi');
            const issueMatches = [...body.matchAll(issuePattern)];

            // Extract direct Jira references
            const jiraPattern = /MEDEASE-\d+/g;
            let jiraKeys = [...new Set((title + ' ' + body).match(jiraPattern) || [])];

            console.log(`Found ${issueMatches.length} GitHub issue references`);
            console.log(`Found ${jiraKeys.length} direct Jira references`);

            // If no GitHub issue is linked, error
            if (issueMatches.length === 0) {
              const errorMessage = `‚ùå **Missing Issue Link**\n\nThis PR must link to a GitHub issue using:\n- \`Fixes #123\`\n- \`Closes #456\`\n- \`Resolves #789\`\n\nPlease add one of these to your PR description.`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: errorMessage
              });

              core.setFailed('PR must link to a GitHub issue');
              return;
            }

            // Fetch linked GitHub issues to extract Jira references
            let linkedIssues = [];
            for (const match of issueMatches) {
              const issueNumber = match[2];
              console.log(`Fetching GitHub issue #${issueNumber}...`);

              try {
                const { data: issue } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNumber)
                });

                linkedIssues.push({
                  number: issueNumber,
                  title: issue.title,
                  body: issue.body || ''
                });

                // Extract Jira key from issue title or body
                const issueJiraKeys = (issue.title + ' ' + issue.body).match(jiraPattern) || [];
                jiraKeys = [...new Set([...jiraKeys, ...issueJiraKeys])];
                console.log(`Found Jira keys in issue #${issueNumber}: ${issueJiraKeys.join(', ')}`);
              } catch (error) {
                console.error(`Failed to fetch issue #${issueNumber}: ${error.message}`);
              }
            }

            if (jiraKeys.length === 0) {
              const errorMessage = `‚ö†Ô∏è **No Jira Reference Found**\n\nThe linked GitHub issue(s) don't contain a Jira reference (MEDEASE-XXX).\n\nPlease ensure the linked issue references a Jira task.`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: errorMessage
              });

              core.setFailed('No Jira reference found');
              return;
            }

            console.log(`Processing Jira keys: ${jiraKeys.join(', ')}`);

            // Fetch Jira issue details
            const jiraToken = process.env.JIRA_API_TOKEN;
            const jiraEmail = process.env.JIRA_EMAIL;
            const jiraBaseUrl = process.env.JIRA_BASE_URL;
            const anthropicKey = process.env.ANTHROPIC_API_KEY;

            if (!jiraToken) {
              console.log('‚ö†Ô∏è JIRA_API_TOKEN not configured');
              core.setFailed('JIRA_API_TOKEN secret not configured');
              return;
            }

            const authHeader = Buffer.from(`${jiraEmail}:${jiraToken}`).toString('base64');

            // Fetch details for all Jira issues
            let jiraIssues = [];
            for (const jiraKey of jiraKeys) {
              console.log(`Fetching Jira details for ${jiraKey}...`);

              try {
                const jiraResponse = await fetch(`${jiraBaseUrl}/rest/api/3/issue/${jiraKey}`, {
                  headers: {
                    'Authorization': `Basic ${authHeader}`,
                    'Accept': 'application/json'
                  }
                });

                if (!jiraResponse.ok) {
                  throw new Error(`Jira API returned ${jiraResponse.status}`);
                }

                const jiraIssue = await jiraResponse.json();

                // Extract description text from ADF format
                let description = 'No description';
                if (jiraIssue.fields.description?.content) {
                  const textParts = [];
                  const extractText = (node) => {
                    if (node.type === 'text' && node.text) {
                      textParts.push(node.text);
                    }
                    if (node.content) {
                      node.content.forEach(extractText);
                    }
                  };
                  jiraIssue.fields.description.content.forEach(extractText);
                  description = textParts.join(' ').trim();
                }

                jiraIssues.push({
                  key: jiraKey,
                  summary: jiraIssue.fields.summary,
                  description: description,
                  status: jiraIssue.fields.status.name,
                  type: jiraIssue.fields.issuetype.name,
                  url: `${jiraBaseUrl}/browse/${jiraKey}`
                });

                console.log(`‚úÖ Fetched ${jiraKey}: ${jiraIssue.fields.summary}`);
              } catch (error) {
                console.error(`Failed to fetch ${jiraKey}: ${error.message}`);
              }
            }

            if (jiraIssues.length === 0) {
              core.setFailed('Failed to fetch Jira details');
              return;
            }

            const primaryJira = jiraIssues[0];

            // Use Claude to generate PR title and description
            let generated;
            if (anthropicKey) {
              console.log('Generating PR content with Claude...');

              try {
                const claudePrompt = `You are a technical writer helping to create a pull request description.

                Jira Issue Details:
                - Key: ${primaryJira.key}
                - Summary: ${primaryJira.summary}
                - Description: ${primaryJira.description}
                - Type: ${primaryJira.type}
                - Status: ${primaryJira.status}

                Linked GitHub Issues:
                ${linkedIssues.map(i => `- #${i.number}: ${i.title}`).join('\n')}

                Code Changes Summary:
                ${prDiff.substring(0, 5000)}

                Generate a concise, professional PR title and description following these rules:

                PR Title Format:
                - Start with: ${primaryJira.key}:
                - Followed by a brief, clear summary of WHAT THIS PR ACTUALLY DOES (not the Jira issue title)
                - Base the summary on the actual code changes shown above
                - Use imperative mood (e.g., "Add", "Fix", "Update")
                - Max 72 chars total
                - Example: "MEDEASE-123: Add bidirectional Jira sync"

                PR Description Format (NO code blocks, just plain markdown):
                ## Description
                [2-3 sentences describing what this PR does based on the actual code changes]

                ## Jira Reference
                - Issue: [${primaryJira.key}](${primaryJira.url})
                - Type: ${primaryJira.type}
                - Status: ${primaryJira.status}

                ## Changes
                - [Bullet point for each major change based on the diff]
                - [Use the actual file changes and code modifications]
                - [Be specific about what was added/modified]

                ## Related Issues
                Fixes #${linkedIssues[0].number}

                Return ONLY a JSON object with this exact structure:
                {
                "title": "MEDEASE-XXX: Brief summary based on actual changes",
                "description": "Full markdown description without code blocks"
                }`;

                const claudeResponse = await fetch('https://api.anthropic.com/v1/messages', {
                  method: 'POST',
                  headers: {
                    'x-api-key': anthropicKey,
                    'anthropic-version': '2023-06-01',
                    'content-type': 'application/json'
                  },
                  body: JSON.stringify({
                    model: 'claude-3-5-sonnet-20241022',
                    max_tokens: 1024,
                    messages: [{
                      role: 'user',
                      content: claudePrompt
                    }]
                  })
                });

                if (!claudeResponse.ok) {
                  throw new Error(`Claude API returned ${claudeResponse.status}`);
                }

                const claudeData = await claudeResponse.json();
                const claudeText = claudeData.content[0].text;

                // Extract JSON from response (handle markdown code blocks)
                let jsonMatch = claudeText.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                  throw new Error('No JSON found in Claude response');
                }

                generated = JSON.parse(jsonMatch[0]);

                console.log('‚úÖ Claude generated:');
                console.log('Title:', generated.title);
                console.log('Description length:', generated.description.length);

                // Update PR
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  title: generated.title,
                  body: generated.description
                });

                console.log('‚úÖ Updated PR title and description');

                // Add success comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `‚úÖ **PR automatically updated with Jira details**\n\nTitle and description generated from [${primaryJira.key}](${primaryJira.url}) using Claude AI.`
                });

              } catch (error) {
                console.error(`Claude generation failed: ${error.message}`);

                // Fallback: Use template-based description
                const fallbackDescription = `## Description
                ${primaryJira.summary}
                
                ## Jira Reference
                **Issue:** [${primaryJira.key}](${primaryJira.url})
                **Type:** ${primaryJira.type}
                **Status:** ${primaryJira.status}
                
                ## Description from Jira
                ${primaryJira.description}
                
                ## Related Issues
                Fixes #${linkedIssues[0].number}`;
                
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  title: `${primaryJira.key}: ${primaryJira.summary}`,
                  body: fallbackDescription
                });

                console.log('‚úÖ Updated PR with fallback template');
              }
            } else {
              console.log('‚ö†Ô∏è ANTHROPIC_API_KEY not configured, using fallback');

              // Fallback without Claude
              const fallbackDescription = `## Description
                ${primaryJira.summary}
                
                ## Jira Reference
                **Issue:** [${primaryJira.key}](${primaryJira.url})
                **Type:** ${primaryJira.type}
                **Status:** ${primaryJira.status}
                
                ## Description from Jira
                ${primaryJira.description}
                
                ## Related Issues
                Fixes #${linkedIssues[0].number}`;
                
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                title: `${primaryJira.key}: ${primaryJira.summary}`,
                body: fallbackDescription
              });

              console.log('‚úÖ Updated PR with template');
            }

            // Add jira-linked label
            try {
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'jira-linked',
                color: '0366d6',
                description: 'PR is linked to a Jira issue'
              });
            } catch (error) {
              // Label exists
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['jira-linked']
            });

            // Add comment to Jira issue linking the PR
            console.log('Adding PR link to Jira issue...');
            try {
              const prUrl = context.payload.pull_request.html_url;
              const prAuthor = context.payload.pull_request.user.login;

              const jiraComment = {
                body: {
                  version: 1,
                  type: 'doc',
                  content: [
                    {
                      type: 'paragraph',
                      content: [
                        {
                          type: 'text',
                          text: 'üîó ',
                          marks: []
                        },
                        {
                          type: 'text',
                          text: 'GitHub Pull Request',
                          marks: [{ type: 'strong' }]
                        }
                      ]
                    },
                    {
                      type: 'paragraph',
                      content: [
                        {
                          type: 'text',
                          text: `PR #${prNumber}: `,
                          marks: []
                        },
                        {
                          type: 'text',
                          text: generated?.title || title,
                          marks: [{ type: 'link', attrs: { href: prUrl } }]
                        }
                      ]
                    },
                    {
                      type: 'paragraph',
                      content: [
                        {
                          type: 'text',
                          text: `Author: @${prAuthor}`,
                          marks: []
                        }
                      ]
                    },
                    {
                      type: 'paragraph',
                      content: [
                        {
                          type: 'text',
                          text: `Status: ${context.payload.pull_request.state}`,
                          marks: []
                        }
                      ]
                    }
                  ]
                }
              };

              const jiraCommentResponse = await fetch(`${jiraBaseUrl}/rest/api/3/issue/${primaryJira.key}/comment`, {
                method: 'POST',
                headers: {
                  'Authorization': `Basic ${authHeader}`,
                  'Accept': 'application/json',
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(jiraComment)
              });

              if (jiraCommentResponse.ok) {
                console.log(`‚úÖ Added PR link to Jira issue ${primaryJira.key}`);
              } else {
                const errorText = await jiraCommentResponse.text();
                console.error(`Failed to add Jira comment: ${jiraCommentResponse.status} - ${errorText}`);
              }
            } catch (error) {
              console.error(`Error adding Jira comment: ${error.message}`);
            }

            console.log('‚úÖ Jira integration complete');

  validate-commits:
    name: Validate commit messages
    runs-on: ubuntu-latest
    steps:
      - name: Check commits for Jira references
        uses: actions/github-script@v7
        with:
          script: |
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const jiraPattern = /MEDEASE-\d+/;
            const invalidCommits = [];

            for (const commit of commits) {
              const message = commit.commit.message;
              const firstLine = message.split('\n')[0];

              // Skip merge commits
              if (firstLine.startsWith('Merge ')) {
                continue;
              }

              if (!jiraPattern.test(firstLine)) {
                invalidCommits.push(`‚ùå \`${commit.sha.substring(0, 7)}\`: ${firstLine.substring(0, 60)}...`);
              }
            }

            if (invalidCommits.length > 0) {
              const message = `‚ö†Ô∏è **Jira Reference Warning**\n\nThe following commits do not reference a Jira issue:\n\n${invalidCommits.join('\n')}\n\n**Best Practice:** Include Jira issue key (MEDEASE-XXX) in commit messages.\n\n**Example:**\n\`\`\`\nMEDEASE-123: Add user authentication\nMEDEASE-456: Fix login bug\n\`\`\``;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: message
              });

              core.warning('Some commits are missing Jira references');
            }
