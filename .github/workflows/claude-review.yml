name: AI Code Review (Claude)

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    name: Generate Claude code review
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && contains(github.event.comment.body, 'claude-review')
    steps:
      - name: Add rocket reaction to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch PR information
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return {
              base: pr.data.base.ref,
              head: pr.data.head.ref,
              title: pr.data.title,
              description: pr.data.body || 'No description provided',
              author: pr.data.user.login
            };

      - name: Checkout PR branch
        run: |
          git fetch origin ${{ fromJSON(steps.pr_info.outputs.result).head }}
          git checkout ${{ fromJSON(steps.pr_info.outputs.result).head }}

      - name: Generate code diff
        id: diff
        run: |
          git fetch origin ${{ fromJSON(steps.pr_info.outputs.result).base }}
          DIFF=$(git diff origin/${{ fromJSON(steps.pr_info.outputs.result).base }}...HEAD)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run AI code review with Claude
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PR_DIFF: ${{ steps.diff.outputs.diff }}
        with:
          script: |
            const https = require('https');

            const prDetails = ${{ steps.pr_info.outputs.result }};
            const diff = process.env.PR_DIFF || '';

            const maxDiffLength = 50000;
            const truncatedDiff = diff.length > maxDiffLength
              ? diff.substring(0, maxDiffLength) + '\n\n... (diff truncated due to length)'
              : diff;

            const prompt = `You are an expert code reviewer. Review this pull request and provide constructive feedback.

            PR Title: ${prDetails.title}
            PR Description: ${prDetails.description}
            PR Author: ${prDetails.author}

            Code Changes:
            \`\`\`diff
            ${truncatedDiff}
            \`\`\`

            Please provide:
            1. A brief summary of the changes
            2. Potential issues or bugs
            3. Code quality and best practices feedback
            4. Security concerns (if any)
            5. Suggestions for improvement

            Keep your review concise and actionable.`;

            const data = JSON.stringify({
              model: 'claude-sonnet-4-5-20250929',
              max_tokens: 8192,
              messages: [{
                role: 'user',
                content: prompt
              }]
            });

            const options = {
              hostname: 'api.anthropic.com',
              path: '/v1/messages',
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': process.env.ANTHROPIC_API_KEY,
                'anthropic-version': '2023-06-01',
                'Content-Length': data.length
              }
            };

            const makeRequest = () => {
              return new Promise((resolve, reject) => {
                const req = https.request(options, (res) => {
                  let body = '';
                  res.on('data', (chunk) => body += chunk);
                  res.on('end', () => {
                    if (res.statusCode === 200) {
                      resolve(JSON.parse(body));
                    } else {
                      reject(new Error('API request failed with status ' + res.statusCode + ' - ' + body));
                    }
                  });
                });
                req.on('error', reject);
                req.write(data);
                req.end();
              });
            };

            try {
              const response = await makeRequest();
              const review = response.content[0].text;

              const commentBody = '## ü§ñ Claude Code Review\n\n' + review + '\n\n---\n*Review powered by Claude Sonnet 4.5*';

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });

              console.log('‚úÖ Claude review posted successfully');
            } catch (error) {
              console.error('‚ùå Error during Claude review:', error.message);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '## ü§ñ Claude Code Review\n\n‚ö†Ô∏è Unable to generate automated review: ' + error.message
              });
            }
